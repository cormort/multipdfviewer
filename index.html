<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF 關鍵字搜尋平台</title>
  <style>
    :root { --toolbar-height: 57px; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    #app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      position: relative; 
    }
    #main-content {
      display: flex;
      flex: 1;
      height: calc(100vh - var(--toolbar-height));
      overflow: hidden;
    }
    #pdf-container {
      flex: 1;
      position: relative;
      overflow: auto;
      background-color: #e9ecef;
      padding: 10px;
    }
    #pdf-canvas, #text-layer, #drawing-canvas {
      display: block;
      margin: 0 auto;
    }
    #pdf-canvas { border: 1px solid #000; }
    #text-layer, #drawing-canvas { position: absolute; pointer-events: none; }
    #drawing-canvas { z-index: 10; }

    #toolbar {
      padding: 10px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      flex-wrap: nowrap; 
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
      height: var(--toolbar-height);
    }
    #toolbar input, #toolbar button, #toolbar select {
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1em;
    }
    #toolbar button:hover { background-color: #e9ecef; }
    #toolbar input[type="text"] { flex: 1 1 150px; min-width: 120px; }

    .zoom-controls { display: flex; align-items: center; gap: 5px; }
    .zoom-controls button.active { background-color: #007bff; color: white; border-color: #007bff; }
    #desktop-zoom-controls { border-left: 1px solid #dee2e6; padding-left: 10px; margin-left: 10px; }
    
    #page-navigation { display: flex; align-items: center; gap: 5px; margin-left: auto; }
    
    #search-results-panel {
      display: none;
      width: 320px;
      flex-shrink: 0;
      background-color: #f1f3f5;
      border-left: 1px solid #dee2e6;
      flex-direction: column;
    }
    #app-container.results-panel-visible #search-results-panel {
      display: flex;
    }
    #panel-dropdown-container { padding: 10px; border-bottom: 1px solid #ccc; }
    /* FIX: Use flex-direction column for vertical stacking */
    .filter-container { display: flex; flex-direction: column; gap: 8px; }
    .filter-container select { width: 100%; }

    #results-list { flex-grow: 1; overflow-y: auto; }
    .result-item { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; }
    .result-item:hover { background-color: #e9ecef; }
    .thumbnail-canvas { width: 100%; border: 1px solid #ccc; margin-bottom: 8px; }
    .page-info { font-weight: bold; font-size: 0.9em; }
    .context-snippet { font-size: 0.85em; }
    .wavy-underline { text-decoration: underline wavy sandybrown; }

    #floating-action-buttons {
      position: fixed; bottom: 20px; right: 20px; z-index: 1003;
      display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
    }
    .fab-button-group { display: flex; flex-direction: row; gap: 10px; }
    #floating-action-buttons button {
      background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%;
      width: 50px; height: 50px; font-size: 24px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    #floating-action-buttons button.active { background-color: #007bff; }

    #bottom-results-bar {
      display: none; position: fixed; bottom: 0; left: 0;
      width: 100%; padding: 8px; background-color: #f8f9fa;
      border-top: 1px solid #dee2e6; z-index: 1002;
    }
    body.results-bar-visible #bottom-results-bar { display: block; }

    #mobile-zoom-controls { display: none; }
    #toolbar-toggle-tab { display: none; }

    @media (max-width: 1024px) {
      #app-container.results-panel-visible #search-results-panel {
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      #desktop-zoom-controls, #page-navigation { display: none; }
      #mobile-zoom-controls { display: flex; width: 100%; justify-content: center; }

      #toolbar-toggle-tab {
        display: flex; align-items: center; justify-content: center;
        position: absolute; top: 40%; left: 0;
        width: 35px; height: 40px; background-color: #ff9a15; color: white;
        border-radius: 0 4px 4px 0; cursor: pointer; z-index: 1003;
        transition: left 0.3s ease;
      }
      #app-container.menu-active #toolbar-toggle-tab { left: 280px; }

      #toolbar {
        position: fixed; top: 0; left: -280px;
        width: 280px; height: 100vh; flex-direction: column;
        align-items: stretch; justify-content: flex-start;
        padding: 50px 15px 20px; gap: 15px; background-color: #f0f0f0;
        border-right: 1px solid #ccc; transition: left 0.3s ease; z-index: 1001;
        overflow-y: auto;
      }
      #app-container.menu-active #toolbar { left: 0; }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="toolbar-toggle-tab"><span class="icon">›</span></div>

    <div id="toolbar">
      <a href="instructions.html" target="_blank" rel="noopener noreferrer" title="在新分頁中開啟使用說明" id="help-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
        </svg>
      </a>
      <div id="restore-session-container" style="display: none;">
        <button id="restore-session-btn" style="background-color: #28a745; color: white;">還原上次的工作階段</button>
      </div>
      <label for="fileInput">選擇 PDF 檔案：</label>
      <input type="file" id="fileInput" accept="application/pdf" multiple />
      <input type="text" id="searchInput" placeholder="關鍵字或正規表示式" />
      <button id="search-action-button">搜尋</button>
      
      <div id="desktop-zoom-controls" class="zoom-controls">
        <button id="zoom-out-btn" title="縮小">-</button>
        <button id="fit-height-btn" title="符合頁面高度">符合高度</button>
        <button id="fit-width-btn" title="符合頁面寬度">符合寬度</button>
        <button id="zoom-in-btn" title="放大">+</button>
      </div>
      
      <div id="page-navigation">
        <button id="go-to-first-page">第一頁</button>
        <button id="prev-page">上一頁</button>
        <input type="range" id="page-slider" min="1" max="1" value="1" disabled>
        <span id="page-num-display">- / -</span>
        <button id="next-page">下一頁</button>
        <input type="number" id="page-to-go" min="1" placeholder="頁碼" style="width: 70px;">
        <button id="go-to-page-btn">前往</button>
      </div>
      
      <div id="mobile-zoom-controls" class="zoom-controls">
          <button id="mobile-zoom-out-btn" title="縮小">-</button>
          <button id="mobile-fit-height-btn" title="符合頁面高度">符合高度</button>
          <button id="mobile-fit-width-btn" title="符合頁面寬度">符合寬度</button>
          <button id="mobile-zoom-in-btn" title="放大">+</button>
      </div>
    </div>

    <div id="main-content">
        <div id="pdf-container">
          <canvas id="pdf-canvas"></canvas>
          <div id="text-layer"></div>
          <canvas id="drawing-canvas"></canvas>
          <div id="magnifier-glass" style="display:none; position:absolute; border:2px solid #333; border-radius:50%; overflow:hidden; z-index:2000; pointer-events:none;"><canvas id="magnifier-canvas"></canvas></div>
        </div>
        <div id="search-results-panel">
            <div id="panel-dropdown-container">
                <h3>搜尋結果</h3>
                <div class="filter-container">
                    <select id="panelFileFilterDropdown"><option value="all">全部檔案</option></select>
                    <select id="panelResultsDropdown"><option value="">頁面摘要</option></select>
                </div>
            </div>
            <div id="results-list"></div>
        </div>
    </div>
  </div>

  <div id="floating-action-buttons" style="display: none;">
    <button id="toggle-underline-btn" title="切換搜尋結果底線"><span class="toggle-underline-icon">S</span></button>
    <div class="fab-button-group">
        <button id="toggle-paragraph-selection-btn" title="啟用段落選取">¶</button>
        <button id="copy-page-text-btn" title="複製頁面文字">📝</button>
        <button id="toggle-text-selection-btn" title="啟用文字選取">TS</button>
    </div>
    <div class="fab-button-group">
        <button id="toggle-highlighter-btn" title="啟用螢光筆">🖌️</button>
        <button id="clear-highlighter-btn" title="清除螢光筆標記">🗑️</button>
    </div>
    <button id="toggle-local-magnifier-btn" title="切換放大鏡">🔍</button>
    <div class="fab-button-group">
        <button id="export-page-btn" title="將目前頁面匯出為圖片">📷</button>
        <button id="share-page-btn" title="分享目前頁面">🔗</button>
    </div>
  </div>

<div id="bottom-results-bar">
    <div class="filter-container">
        <select id="fileFilterDropdown"><option value="all">全部檔案</option></select>
        <select id="resultsDropdown"><option value="">頁面摘要</option></select>
    </div>
</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  
  <script type="module">
    import { GlobalWorkerOptions } from './lib/pdfjs/pdf.mjs'; 
    GlobalWorkerOptions.workerSrc = './lib/pdfjs/pdf.worker.mjs';
  </script>
  <script type="module" src="./script.js"></script>
</body>
</html>
